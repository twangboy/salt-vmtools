# Copyright 2021-2023 VMware, Inc.
# SPDX-License-Identifier: Apache-2

---
stages:
  - lint
  - pre-commit
  - build_svt
  - test_svt

variables:
  PLUGIN_PACKAGES: "*.sh"
  CICD_UPSTREAM_PATH: "saltstack/open/salt-vm-tools"
  CICD_SALT_SCRIPT_VERSION: "1.5"
  CICD_SALT_SCRIPT_COMP_VERSION: "1.5.0"
  CICD_SALT_SCRIPT_RELEASE: "1"
  CICD_SALT_SCRIPT_DATE: "Thu Jan 1 1970"
  CICD_SALT_SCRIPT_BRANCH: "main"

workflow:
  rules:
    - if: $CI_MERGE_REQUEST_ID == null

include:
  - project: saltstack/pop/cicd/ci-templates
    file: /lint/pre-commit-run-all.yml

build-salt-vmtools-linux:
  stage: build_svt
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_SHORT_SHA"
    paths:
      - metadata.json
      - svtminion.sh
    expire_in: 120 days
#    reports:
#      dotenv: build.env
  image: centos:7
         ## almalinux:8
  script:
    # assumes running as root
    - oldpwd=$(pwd)
    - mkdir /root/ || true
    - echo "machine gitlab.com login gitlab-ci-token password ${CI_JOB_TOKEN}" >> ~/.netrc
    # setup environment vars
    - export CICD_SALT_SCRIPT_DATE=$(date +"%a %b %0d %Y")
    - export CICD_SALT_SCRIPT_VERSION_DATE=$(date "+%Y-%m-%d-%H:%M")
    # generate sha256 for metadata.json file
    - cd linux
    - cp linux_metadata.json metadata.json
    - sed -i -e 's&SALT_SCRIPT_VERSION&'${CICD_SALT_SCRIPT_VERSION}'&' metadata.json
    - sed -i -e 's&SALT_SCRIPT_COMP_VERSION&'${CICD_SALT_SCRIPT_COMP_VERSION}'&' metadata.json
    - svtminion_sha256=$(sha256sum svtminion.sh | cut -d ' ' -f 1)
    - sed -i -e 's&SVTMINION_SHA256&'${svtminion_sha256}'&' metadata.json
    - cat metadata.json
    - sed -i -e 's&SCRIPT_VERSION_REPLACE&'${CICD_SALT_SCRIPT_VERSION_DATE}-${CI_COMMIT_SHORT_SHA}'&' svtminion.sh
    - cp -f metadata.json ${oldpwd}/metadata.json
    - cp -f svtminion.sh ${oldpwd}/svtminion.sh

  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: on_success


build-salt-vmtools-windows:
  stage: build_svt
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - svtminion.ps1
    expire_in: 120 days
  image: centos:7
  script:
    - oldpwd=$(pwd)
    - cd windows
    - export CICD_SALT_SCRIPT_VERSION_DATE=$(date "+%Y-%m-%d-%H:%M")
    - sed -i -e 's&SCRIPT_VERSION_REPLACE&'${CICD_SALT_SCRIPT_VERSION_DATE}-${CI_COMMIT_SHORT_SHA}'&' svtminion.ps1
    - cp -f svtminion.ps1 ${oldpwd}/svtminion.ps1

  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: on_success


build-tags-salt-vmtools-linux:
  stage: build_svt
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - metadata.json
      - svtminion.sh
    expire_in: 120 days
#    reports:
#      dotenv: build.env
  image: centos:7
         ## almalinux:8
  script:
    # assumes running as root
    - oldpwd=$(pwd)
    - mkdir /root/ || true
    - echo "machine gitlab.com login gitlab-ci-token password ${CI_JOB_TOKEN}" >> ~/.netrc
    # setup environment vars
    - export CICD_SALT_SCRIPT_DATE=$(date +"%a %b %0d %Y")
    # generate sha256 for metadata.json file
    - cd linux
    - cp linux_metadata.json metadata.json
    # expect tag of version form x.y-z where -z is release number
    - export CICD_SALT_SCRIPT_VERSION=$(echo "${CI_COMMIT_TAG}" | sed s/v// | cut -d '-' -f 1)
    - export CICD_SALT_SCRIPT_RELEASE=$(echo "${CI_COMMIT_TAG}" | sed s/v// | cut -d '-' -f 2)
    ## ensure if no release number given default to 1
    - if [[ "${CICD_SALT_SCRIPT_VERSION}" = "${CICD_SALT_SCRIPT_RELEASE}" ]]; then export CICD_SALT_SCRIPT_RELEASE=1; fi
    - sed -i -e 's&SALT_SCRIPT_VERSION&'${CICD_SALT_SCRIPT_VERSION}'&' metadata.json
    - sed -i -e 's&SALT_SCRIPT_COMP_VERSION&'${CICD_SALT_SCRIPT_VERSION}.${CICD_SALT_SCRIPT_RELEASE}'&' metadata.json
    - svtminion_sha256=$(sha256sum svtminion.sh | cut -d ' ' -f 1)
    - sed -i -e 's&SVTMINION_SHA256&'${svtminion_sha256}'&' metadata.json
    - cat metadata.json
    ## this needs rework since not affecting release sub-dir in repository, but on VM
    ## added test to linux to check release is updated
    ## - sed -i -e 's&SCRIPT_VERSION_REPLACE&'${CI_COMMIT_TAG}'&' svtminion.sh
    - cp -f metadata.json ${oldpwd}/metadata.json
    - cp -f svtminion.sh ${oldpwd}/svtminion.sh

  rules:
    - if: "$CI_COMMIT_TAG != null && $CI_PROJECT_PATH == $CICD_UPSTREAM_PATH"
      when: always
    - when: never


build-tags-salt-vmtools-windows:
  stage: build_svt
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    paths:
      - svtminion.ps1
    expire_in: 120 days
  image: centos:7
  script:
    - oldpwd=$(pwd)
    - cd windows
    - sed -i -e 's&SCRIPT_VERSION_REPLACE&'${CI_COMMIT_TAG}'&' svtminion.ps1
    - cp -f svtminion.ps1 ${oldpwd}/svtminion.ps1

  rules:
    - if: "$CI_COMMIT_TAG != null && $CI_PROJECT_PATH == $CICD_UPSTREAM_PATH"
      when: always
    - when: never


test-salt-vmtools-linux:
  stage: test_svt
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    expire_in: 120 days
  needs:
    - job: build-salt-vmtools-linux
  tags:
    - ss-custom-ec2-linux
  image: saltstack/cicd/ec2-amis/glr/rocky/8/*
  variables:
    SPOT_INSTANCE: "false"
    IMAGE_USER: "rocky"
    WINDOWS_GUEST: "false"
  script:
    - oldpwd=$(pwd)
    - sudo -u root  mkdir -p /root/ || true
    - echo "machine gitlab.com login gitlab-ci-token password ${CI_JOB_TOKEN}" >> ~/.netrc
    - id
    - ls -alh svtminion.sh
    - date
    - sudo -u root yum makecache
    - sudo -u root ./svtminion.sh --depend || { _retn=$?; if [[ ${_retn} -eq 126 ]]; then echo "test correct"; else echo "test failed, should be missing at least the vmtoolsd dependency, returned '${_retn}'"; exit 1; fi; }
    - ls -alh /var/log/vmware-svtminion.sh-depend-*
    - sudo -u root yum -y install open-vm-tools
    - sudo -u root yum -y install curl
    - sudo -u root yum -y install wget
    - sudo -u root ./svtminion.sh --depend --loglevel info || { _retn=$?; echo "test failed, there should be no missing dependencies, returned '${_retn}'"; }
    - ls -l /var/log/vmware-svtminion.sh-depend-* | wc -l
    - if [[ 2 -eq $(ls -l /var/log/vmware-svtminion.sh-depend-* | wc -l) ]]; then echo "test correct"; else "test failed, should be 2 depend log files"; exit 1; fi
    - ps -ef | grep svtminion
    - sudo -u root pgrep -f "svtminion.sh"
    - sudo -u root ./svtminion.sh --status --loglevel info || { _retn=$?; if [[ ${_retn} -eq 102 ]]; then echo "test correct"; else echo "test failed, salt-minion should not be installed, returned '${_retn}'"; exit 1; fi; }
    - ls -alh /var/log/vmware-svtminion.sh-status-*
    - sudo -u root ./svtminion.sh --status && { echo "test failed- expecting 102 exit code, salt-minion should not be installed"; exit 1; }
    - sudo -u root ./svtminion.sh --install master=192.168.0.5 --loglevel debug
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - myhost=$(hostname)
    - myfqdn=$(sudo -u root /usr/bin/salt-call --local grains.get fqdn | sed "s/'//g")
    - if [[ "${myhost}" = "${myfqdn}" ]]; then "echo test correct" else echo "test failed, FQDN '${myfqdn}' should have match hostname '${myhost}'"; exit 1; fi
    - ls -alh /opt/saltstack/salt/salt-minion
    - ls -alh /usr/bin/salt-call
    - ls -alh /usr/bin/salt-minion
    - getent group salt | grep -w salt
    - cat /etc/passwd | grep -w salt
    - sudo -u root /usr/bin/salt-call --local test.versions
    - sudo -u root /usr/bin/salt-call --local grains.items
    - sudo -u root /usr/bin/salt-call --local cmd.run "ls -al /"
    - sudo -u root ./svtminion.sh --status || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sudo -u root ./svtminion.sh --clear myminion
    - cat /etc/salt/minion | grep 'id:\ myminion' 1>/dev/null
    - sudo -u root ./svtminion.sh --clear
    - cat /etc/salt/minion | grep '# id:\ myminion' 1>/dev/null
    - cat /etc/salt/minion | grep 'id:\ myminion_' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - list_dirs_to_chk_removed="/opt/saltstack /etc/salt /var/run/salt /var/cache/salt /var/log/salt"
    - for idx in ${list_dirs_to_chk_removed}; do if [[ -d "${idx}" ]]; then echo "directory ${idx} is left after a remove"; exit 1; fi; done
    - list_files_to_chk_removed="/usr/bin/salt-call /usr/bin/salt-minion /usr/lib/systemd/system/salt-minion.service /etc/systemd/system/salt-minion.service"
    - for idx in ${list_files_to_chk_removed}; do if [[ -f "${idx}" ]]; then echo "file ${idx} is left after a remove"; exit 1; fi; done
    - sudo -u root ./svtminion.sh --status || { _retn=$?; if [[ ${_retn} -eq 102 ]]; then echo "test correct"; else echo "test failed, salt-minion should not be installed, returned '${_retn}'"; exit 1; fi; }
    - sudo -u root ./svtminion.sh --status && { echo "test failed- expecting 102 exit code, salt-minion should not be installed"; exit 1; }
    - sudo -u root ./svtminion.sh --version --loglevel debug
    - ls -alh /var/log/vmware-svtminion.sh-default-*
    - sudo -u root ./svtminion.sh --minionversion "3004.2-1" --install master=192.168.0.6 --loglevel debug
    - ls -alh /opt/saltstack/salt/run/
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.6' 1>/dev/null
    - myhost=$(hostname)
    - myfqdn=$(sudo -u root /usr/bin/salt-call --local grains.get fqdn | sed "s/'//g")
    - if [[ "${myhost}" = "${myfqdn}" ]]; then "echo test correct" else echo "test failed, FQDN '${myfqdn}' should have match hostname '${myhost}'"; exit 1; fi
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - ls -l /var/log/vmware-svtminion.sh-status-*
    - ls -l /var/log/vmware-svtminion.sh-status-* | wc -l
    - if [[ 5 -eq $(ls -l /var/log/vmware-svtminion.sh-status-* | wc -l) ]]; then echo "test correct"; else "test failed, should be only 5 status log files"; exit 1; fi
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    # test source installs with repo.json
    - sudo -u root ./svtminion.sh --source ${oldpwd}/tests/testarea --install master=192.168.0.5 --loglevel debug
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - sudo -u root ./svtminion.sh --source file:/${oldpwd}/tests/testarea --install master=192.168.0.5 --loglevel debug
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - sudo -u root ./svtminion.sh --source ${oldpwd}/tests/testarea --install master=192.168.0.5 --loglevel debug
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - sudo -u root ./svtminion.sh --install master=192.168.0.5 --loglevel debug --source file:/${oldpwd}/tests/testarea -m "3003.3-1"
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - sudo -u root ./svtminion.sh --install master=192.168.0.5 --loglevel debug --source https://repo.saltproject.io/salt/vmware-tools-onedir
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    # test source installs with repo.json post_3005
    - sudo -u root ./svtminion.sh --source ${oldpwd}/tests/testarea/test_onedir --install master=192.168.0.5 --loglevel debug
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 102 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --source ${oldpwd}/tests/testarea/test_onedir --install master=192.168.0.5 --loglevel debug --minionversion 3006
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - sudo -u root ./svtminion.sh --source ${oldpwd}/tests/testarea/test_onedir --install master=192.168.0.5 --loglevel debug --minionversion 3006.6
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - sudo -u root ./svtminion.sh --source ${oldpwd}/tests/testarea/test_onedir --install master=192.168.0.5 --loglevel debug --minionversion 3007
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - sudo -u root ./svtminion.sh --install master=192.168.0.5 --loglevel debug --source https://staging.repo.saltproject.io/salt_rc/salt/py3/onedir
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    # test stop and start
    - sudo -u root ./svtminion.sh --install master=192.168.0.5 --loglevel debug --source https://staging.repo.saltproject.io/salt/py3/onedir
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ps -ef | grep salt
    - systemctl is-active salt-minion
    # VM Tools doesn't support 107 for now... until then we return 100
    - sudo -u root ./svtminion.sh --stop --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be stopped, returned '${_retn}'"; exit 1; fi; }
    - sudo -u root ps -ef | grep salt
    - systemctl is-active salt-minion || { echo "test correct"; }
    - sudo -u root ps -ef | grep salt
    - sudo -u root ./svtminion.sh --start --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be running, returned '${_retn}'"; exit 1; fi; }
    - sudo -u root ps -ef | grep salt
    - systemctl is-active salt-minion || { echo "test failed, salt-minion should be running"; exit 1; }
    # test reconfig
    - cat /etc/salt/minion
    - sudo -u root ./svtminion.sh --reconfig master=192.168.0.7 --loglevel debug
    - sleep 3
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be running, returned '${_retn}'"; exit 1; fi; }
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.7' 1>/dev/null
    - sudo -u root ps -ef | grep salt
    - systemctl is-active salt-minion
    # test 3006-3007 and upgrade
    - ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - sleep 1
    - sudo -u root ./svtminion.sh --source ${oldpwd}/tests/testarea/test_onedir --install master=192.168.0.5 id="tup" --loglevel debug --minionversion 3006
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - cat /etc/salt/minion | grep 'id:\ tup' 1>/dev/null
    - sudo -u root ps -ef | grep salt
    - systemctl is-active salt-minion
    - if [[ $(sudo -u root /usr/bin/salt-call --local test.version --out=pprint | awk '{print $2}' | cut -d "'" -f 2 | awk -F "." '{print $1}') -eq 3006 ]]; then echo "test correct"; else echo "test failed, wrong major version for salt-minion"; exit 1; fi
    - sudo -u root ./svtminion.sh --source ${oldpwd}/tests/testarea/test_onedir --upgrade --install --loglevel debug --minionversion 3007
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - cat /etc/salt/minion | grep 'id:\ tup' 1>/dev/null
    - sudo -u root ps -ef | grep salt
    - systemctl is-active salt-minion
    - if [[ $(sudo -u root /usr/bin/salt-call --local test.version --out=pprint | awk '{print $2}' | cut -d "'" -f 2 | awk -F "." '{print $1}') -eq 3007 ]]; then echo "test correct"; else echo "test failed, wrong major version for salt-minion"; exit 1; fi
    # test source installs without repo.json
    - cd ${oldpwd}/tests/testarea
    - mv repo.json repo.json_hold
    - cd ${oldpwd}
    - sudo -u root ./svtminion.sh --source ${oldpwd}/tests/testarea --install master=192.168.0.5 --loglevel debug
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - sudo -u root ./svtminion.sh --install master=192.168.0.5 --loglevel debug --source file:/${oldpwd}/tests/testarea -m 3004-1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - sudo -u root ./svtminion.sh --install master=192.168.0.5 --loglevel debug --source https://repo.saltproject.io/salt/vmware-tools-onedir
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - cd ${oldpwd}/tests/testarea
    - mv repo.json_hold repo.json
    - cd ${oldpwd}
    # test source installs without repo.json for post_3005
    - cd ${oldpwd}/tests/testarea/test_onedir
    - mv repo.json repo.json_hold
    - cd ${oldpwd}
    - sudo -u root ./svtminion.sh --source ${oldpwd}/tests/testarea/test_onedir --install master=192.168.0.5 --loglevel debug
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    # restore normal test source installs with 2 repo.json for post_3005
    - cd ${oldpwd}/tests/testarea/test_onedir
    - mv repo.json_hold repo.json
    - cd ${oldpwd}
    - sudo -u root bash -x ./svtminion.sh --install master=192.168.0.5 --loglevel debug --source file:/${oldpwd}/tests/testarea/test_onedir -m 3007.1
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    # test with classic package installed
    - sudo -u root rpm --import https://repo.saltproject.io/py3/redhat/8/x86_64/3005/SALTSTACK-GPG-KEY.pub
    - sudo -u root curl -fsSL https://repo.saltproject.io/py3/redhat/8/x86_64/3005.repo | sudo -u root tee /etc/yum.repos.d/salt.repo
    - sudo -u root yum makecache
    - sudo -u root yum -y install salt-minion
    - sudo -u root ./svtminion.sh --install master=192.168.0.5 --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 106 ]]; then echo "test correct"; else echo "test failed, should fail since be standard salt-minion installed, returned '${_retn}'"; exit 1; fi; }
    - sudo -u root ./svtminion.sh --status --loglevel info || { _retn=$?; if [[ ${_retn} -eq 106 ]]; then echo "test correct"; else echo "test failed, classic salt-minion should be installed and external install detected, returned '${_retn}'"; exit 1; fi; }
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; if [[ ${_retn} -eq 106 ]]; then echo "test correct"; else echo "test failed, should fail since be standard salt-minion installed and script remove not valid, returned '${_retn}'"; exit 1; fi; }

  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: on_success


test-salt-vmtools-windows:
  stage: test_svt
  tags:
    - saas-windows-medium-amd64
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    expire_in: 120 days
  needs:
    - job: build-salt-vmtools-windows
  script:
    # Move the artifact to the original location to be tested
    - Move-Item .\svtminion.ps1 .\windows\svtminion.ps1 -Force
    # Make sure we can run the script
    - try { .\windows\svtminion.ps1 | Out-Null } catch {} finally { if ( $LASTEXITCODE -ne 126 ) { Write-Host "Failed to execute"; exit 1 } else { $LASTEXITCODE = 0 } }
    # Make sure we can display help
    - try { .\windows\svtminion.ps1 -Help | Out-Null } catch {} finally { if ( $LASTEXITCODE -ne 0 ) { Write-Host "Status not 0"; exit 1 } }
    # Make sure we get a status
    - try { .\windows\svtminion.ps1 -Status | Out-Null } catch {} finally { if ( $LASTEXITCODE -ge 100 ) { Write-Host "Status not 102"; exit 1 } else { $LASTEXITCODE = 0 }}
    # Running functional tests (must be run with powershell -file)
    - powershell -file .\tests\windows\runtests.ps1
    # Running integration tests (must be run with powershell -file)
    - powershell -file .\tests\windows\runtests.ps1 -Integration

  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: on_success


test-tags-salt-vmtools-linux:
  stage: test_svt
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    expire_in: 120 days
  needs:
    - job: build-tags-salt-vmtools-linux
  tags:
    - ss-custom-ec2-linux
  image: saltstack/cicd/ec2-amis/glr/rocky/8/*
  variables:
    SPOT_INSTANCE: "false"
    IMAGE_USER: "rocky"
    WINDOWS_GUEST: "false"
  script:
    - oldpwd=$(pwd)
    - sudo -u root  mkdir -p /root/ || true
    - echo "machine gitlab.com login gitlab-ci-token password ${CI_JOB_TOKEN}" >> ~/.netrc
    - id
    - ls -alh svtminion.sh
    - date
    - sudo -u root yum makecache
    - sudo -u root ./svtminion.sh --depend || { _retn=$?; if [[ ${_retn} -eq 126 ]]; then echo "test correct"; else echo "test failed, should be missing at least the vmtoolsd dependency, returned '${_retn}'"; exit 1; fi; }
    - ls -alh /var/log/vmware-svtminion.sh-depend-*
    - sudo -u root yum -y install open-vm-tools
    - sudo -u root yum -y install curl
    - sudo -u root yum -y install wget
    - sudo -u root ./svtminion.sh --depend --loglevel info || { _retn=$?; echo "test failed, there should be no missing dependencies, returned '${_retn}'"; }
    - ls -l /var/log/vmware-svtminion.sh-depend-* | wc -l
    - if [[ 2 -eq $(ls -l /var/log/vmware-svtminion.sh-depend-* | wc -l) ]]; then echo "test correct"; else "test failed, should be 2 depend log files"; exit 1; fi
    - ps -ef | grep svtminion
    - sudo -u root pgrep -f "svtminion.sh"
    - sudo -u root ./svtminion.sh --status --loglevel info || { _retn=$?; if [[ ${_retn} -eq 102 ]]; then echo "test correct"; else echo "test failed, salt-minion should not be installed, returned '${_retn}'"; exit 1; fi; }
    - ls -alh /var/log/vmware-svtminion.sh-status-*
    - sudo -u root ./svtminion.sh --status && { echo "test failed- expecting 102 exit code, salt-minion should not be installed"; exit 1; }
    - sudo -u root ./svtminion.sh --install master=192.168.0.5 --loglevel debug
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - myhost=$(hostname)
    - myfqdn=$(sudo -u root /usr/bin/salt-call --local grains.get fqdn | sed "s/'//g")
    - if [[ "${myhost}" = "${myfqdn}" ]]; then "echo test correct" else echo "test failed, FQDN '${myfqdn}' should have match hostname '${myhost}'"; exit 1; fi
    - ls -alh /opt/saltstack/salt/salt-minion
    - ls -alh /usr/bin/salt-call
    - ls -alh /usr/bin/salt-minion
    - getent group salt | grep -w salt
    - cat /etc/passwd | grep -w salt
    - sudo -u root /usr/bin/salt-call --local test.versions
    - sudo -u root /usr/bin/salt-call --local grains.items
    - sudo -u root /usr/bin/salt-call --local cmd.run "ls -al /"
    - sudo -u root ./svtminion.sh --status || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sudo -u root ./svtminion.sh --clear myminion
    - cat /etc/salt/minion | grep 'id:\ myminion' 1>/dev/null
    - sudo -u root ./svtminion.sh --clear
    - cat /etc/salt/minion | grep '# id:\ myminion' 1>/dev/null
    - cat /etc/salt/minion | grep 'id:\ myminion_' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - list_dirs_to_chk_removed="/opt/saltstack /etc/salt /var/run/salt /var/cache/salt /var/log/salt"
    - for idx in ${list_dirs_to_chk_removed}; do if [[ -d "${idx}" ]]; then echo "directory ${idx} is left after a remove"; exit 1; fi; done
    - list_files_to_chk_removed="/usr/bin/salt-call /usr/bin/salt-minion /usr/lib/systemd/system/salt-minion.service /etc/systemd/system/salt-minion.service"
    - for idx in ${list_files_to_chk_removed}; do if [[ -f "${idx}" ]]; then echo "file ${idx} is left after a remove"; exit 1; fi; done
    - sudo -u root ./svtminion.sh --status || { _retn=$?; if [[ ${_retn} -eq 102 ]]; then echo "test correct"; else echo "test failed, salt-minion should not be installed, returned '${_retn}'"; exit 1; fi; }
    - sudo -u root ./svtminion.sh --status && { echo "test failed- expecting 102 exit code, salt-minion should not be installed"; exit 1; }
    - sudo -u root ./svtminion.sh --version --loglevel debug
    - ls -alh /var/log/vmware-svtminion.sh-default-*
    - sudo -u root ./svtminion.sh --minionversion "3004.2-1" --install master=192.168.0.6 --loglevel debug
    - ls -alh /opt/saltstack/salt/run/
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.6' 1>/dev/null
    - myhost=$(hostname)
    - myfqdn=$(sudo -u root /usr/bin/salt-call --local grains.get fqdn | sed "s/'//g")
    - if [[ "${myhost}" = "${myfqdn}" ]]; then "echo test correct" else echo "test failed, FQDN '${myfqdn}' should have match hostname '${myhost}'"; exit 1; fi
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - ls -l /var/log/vmware-svtminion.sh-status-*
    - ls -l /var/log/vmware-svtminion.sh-status-* | wc -l
    - if [[ 5 -eq $(ls -l /var/log/vmware-svtminion.sh-status-* | wc -l) ]]; then echo "test correct"; else "test failed, should be only 5 status log files"; exit 1; fi
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    # test source installs with repo.json
    - sudo -u root ./svtminion.sh --source ${oldpwd}/tests/testarea --install master=192.168.0.5 --loglevel debug
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - sudo -u root ./svtminion.sh --source file:/${oldpwd}/tests/testarea --install master=192.168.0.5 --loglevel debug
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - sudo -u root ./svtminion.sh --source ${oldpwd}/tests/testarea --install master=192.168.0.5 --loglevel debug
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - sudo -u root ./svtminion.sh --install master=192.168.0.5 --loglevel debug --source file:/${oldpwd}/tests/testarea -m "3003.3-1"
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - sudo -u root ./svtminion.sh --install master=192.168.0.5 --loglevel debug --source https://repo.saltproject.io/salt/vmware-tools-onedir
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    # test source installs with repo.json post_3005
    - sudo -u root ./svtminion.sh --source ${oldpwd}/tests/testarea/test_onedir --install master=192.168.0.5 --loglevel debug
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 102 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - sudo -u root ./svtminion.sh --source ${oldpwd}/tests/testarea/test_onedir --install master=192.168.0.5 --loglevel debug --minionversion 3006
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - sudo -u root ./svtminion.sh --source ${oldpwd}/tests/testarea/test_onedir --install master=192.168.0.5 --loglevel debug --minionversion 3006.6
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - sudo -u root ./svtminion.sh --source ${oldpwd}/tests/testarea/test_onedir/minor --install master=192.168.0.5 --loglevel debug --minionversion 3006.7
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - sudo -u root ./svtminion.sh --install master=192.168.0.5 --loglevel debug --source https://staging.repo.saltproject.io/salt_rc/salt/py3/onedir
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    # test start, stop, reconfig
    - sudo -u root ./svtminion.sh --install master=192.168.0.5 --loglevel debug --source https://staging.repo.saltproject.io/salt/py3/onedir
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sleep 1
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ps -ef | grep salt
    - sudo -u root systemctl is-active salt-minion
    # VM Tools doesn't support 107 for now... until then we return 100
    - sudo -u root ./svtminion.sh --stop --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be stopped, returned '${_retn}'"; exit 1; fi; }
    - sudo -u root ps -ef | grep salt
    - systemctl is-active salt-minion || { echo "test correct"; }
    - sudo -u root ps -ef | grep salt
    - sudo -u root ./svtminion.sh --start --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be running, returned '${_retn}'"; exit 1; fi; }
    - sudo -u root ps -ef | grep salt
    - systemctl is-active salt-minion || { echo "test failed, salt-minion should be running"; exit 1; }
    # test 3006-3007 and upgrade
    - ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - sleep 1
    - sudo -u root ./svtminion.sh --source ${oldpwd}/tests/testarea/test_onedir --install master=192.168.0.5 id="tup" --loglevel debug --minionversion 3006
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - cat /etc/salt/minion | grep 'id:\ tup' 1>/dev/null
    - sudo -u root ps -ef | grep salt
    - systemctl is-active salt-minion
    - if [[ $(sudo -u root /usr/bin/salt-call --local test.version --out=pprint | awk '{print $2}' | cut -d "'" -f 2 | awk -F "." '{print $1}') -eq 3006 ]]; then echo "test correct"; else echo "test failed, wrong major version for salt-minion"; exit 1; fi
    - sudo -u root ./svtminion.sh --source ${oldpwd}/tests/testarea/test_onedir --upgrade --install --loglevel debug --minionversion 3007
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - cat /etc/salt/minion | grep 'id:\ tup' 1>/dev/null
    - sudo -u root ps -ef | grep salt
    - systemctl is-active salt-minion
    - if [[ $(sudo -u root /usr/bin/salt-call --local test.version --out=pprint | awk '{print $2}' | cut -d "'" -f 2 | awk -F "." '{print $1}') -eq 3007 ]]; then echo "test correct"; else echo "test failed, wrong major version for salt-minion"; exit 1; fi
    # test source installs without repo.json
    - cd ${oldpwd}/tests/testarea
    - mv repo.json repo.json_hold
    - cd ${oldpwd}
    - sudo -u root ./svtminion.sh --source ${oldpwd}/tests/testarea --install master=192.168.0.5 --loglevel debug
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - sudo -u root ./svtminion.sh --install master=192.168.0.5 --loglevel debug --source file:/${oldpwd}/tests/testarea -m 3004-1
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - sudo -u root ./svtminion.sh --install master=192.168.0.5 --loglevel debug --source https://repo.saltproject.io/salt/vmware-tools-onedir
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    - cd ${oldpwd}/tests/testarea
    - mv repo.json_hold repo.json
    - cd ${oldpwd}
    # test source installs without repo.json for post_3005
    - cd ${oldpwd}/tests/testarea/test_onedir
    - mv repo.json repo.json_hold
    - cd ${oldpwd}
    - sudo -u root ./svtminion.sh --source ${oldpwd}/tests/testarea/test_onedir --install master=192.168.0.5 --loglevel debug
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    # restore normal test source installs with 2 repo.json for post_3005
    - cd ${oldpwd}/tests/testarea/test_onedir
    - mv repo.json_hold repo.json
    - cd ${oldpwd}
    - sudo -u root bash -x ./svtminion.sh --install master=192.168.0.5 --loglevel debug --source file:/${oldpwd}/tests/testarea/test_onedir -m 3007.1
    - cat /etc/salt/minion
    - cat /etc/salt/minion | grep 'master:\ 192.168.0.5' 1>/dev/null
    - sudo -u root ./svtminion.sh --status --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 100 ]]; then echo "test correct"; else echo "test failed, salt-minion should be installed, returned '${_retn}'"; exit 1; fi; }
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; echo "test failed, did not uninstall the salt-minion, returned '${_retn}'"; }
    # test with classic package installed
    - sudo -u root rpm --import https://repo.saltproject.io/py3/redhat/8/x86_64/3005/SALTSTACK-GPG-KEY.pub
    - sudo -u root curl -fsSL https://repo.saltproject.io/py3/redhat/8/x86_64/3005.repo | sudo -u root tee /etc/yum.repos.d/salt.repo
    - sudo -u root yum makecache
    - sudo -u root yum -y install salt-minion
    - sudo -u root ./svtminion.sh --install master=192.168.0.5 --loglevel debug || { _retn=$?; if [[ ${_retn} -eq 106 ]]; then echo "test correct"; else echo "test failed, should fail since be standard salt-minion installed, returned '${_retn}'"; exit 1; fi; }
    - sudo -u root ./svtminion.sh --status --loglevel info || { _retn=$?; if [[ ${_retn} -eq 106 ]]; then echo "test correct"; else echo "test failed, classic salt-minion should be installed and external install detected, returned '${_retn}'"; exit 1; fi; }
    - sudo -u root ./svtminion.sh --remove || { _retn=$?; if [[ ${_retn} -eq 106 ]]; then echo "test correct"; else echo "test failed, should fail since be standard salt-minion installed and script remove not valid, returned '${_retn}'"; exit 1; fi; }

  rules:
    - if: "$CI_COMMIT_TAG != null && $CI_PROJECT_PATH == $CICD_UPSTREAM_PATH"
      when: always
    - when: never


test-tags-salt-vmtools-windows:
  stage: test_svt
  tags:
    ## - shared-windows
    ## - windows
    ## - windows-1809
    - saas-windows-medium-amd64
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_NAME"
    expire_in: 120 days
  needs:
    - job: build-tags-salt-vmtools-windows
  script:
    # Move the artifact to the original location to be tested
    - Move-Item .\svtminion.ps1 .\windows\svtminion.ps1 -Force
    # Make sure we can run the script
    - try { .\windows\svtminion.ps1 | Out-Null } catch {} finally { if ( $LASTEXITCODE -ne 126 ) { Write-Host "Failed to execute"; exit 1 } else { $LASTEXITCODE = 0 } }
    # Make sure we can display help
    - try { .\windows\svtminion.ps1 -Help | Out-Null } catch {} finally { if ( $LASTEXITCODE -ne 0 ) { Write-Host "Status not 0"; exit 1 } }
    # Make sure we get a status
    - try { .\windows\svtminion.ps1 -Status | Out-Null } catch {} finally { if ( $LASTEXITCODE -ge 100 ) { Write-Host "Status not 102"; exit 1 } else { $LASTEXITCODE = 0 }}
    # Running functional tests (must be run with powershell -file)
    - powershell -file .\tests\windows\runtests.ps1
    # Running integration tests (must be run with powershell -file)
    - powershell -file .\tests\windows\runtests.ps1 -Integration

  rules:
    - if: "$CI_COMMIT_TAG != null && $CI_PROJECT_PATH == $CICD_UPSTREAM_PATH"
      when: always
    - when: never
